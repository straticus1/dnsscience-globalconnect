#!/bin/bash
# Facility Sync Cron Script
# Syncs data center facility information from PeeringDB
#
# Recommended: Run every 6 hours to stay current with global facility changes
#
# Installation:
#   1. Copy this script to /etc/cron.d/globaldetect-facility-sync
#   2. Or add to crontab: crontab -e
#
# Crontab entry (every 6 hours):
#   0 */6 * * * /path/to/globaldetect facility sync --quiet >> /var/log/globaldetect/facility-sync.log 2>&1
#
# Or for /etc/cron.d (runs as specific user):
#   0 */6 * * * root /usr/local/bin/globaldetect facility sync --quiet >> /var/log/globaldetect/facility-sync.log 2>&1
#
# Copyright (c) 2025 DNS Science.io, an After Dark Systems, LLC company.
# All rights reserved.

set -e

# Configuration
GLOBALDETECT_BIN="${GLOBALDETECT_BIN:-/usr/local/bin/globaldetect}"
LOG_DIR="${LOG_DIR:-/var/log/globaldetect}"
LOG_FILE="${LOG_DIR}/facility-sync.log"
LOCK_FILE="/var/run/globaldetect-facility-sync.lock"

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

# Check for lock file (prevent concurrent runs)
if [ -f "$LOCK_FILE" ]; then
    pid=$(cat "$LOCK_FILE")
    if kill -0 "$pid" 2>/dev/null; then
        log "ERROR: Another sync is already running (PID: $pid)"
        exit 1
    else
        log "WARNING: Stale lock file found, removing"
        rm -f "$LOCK_FILE"
    fi
fi

# Create lock file
echo $$ > "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

log "Starting PeeringDB facility sync"

# Run incremental sync
if "$GLOBALDETECT_BIN" facility sync --quiet; then
    log "Sync completed successfully"
else
    exit_code=$?
    log "ERROR: Sync failed with exit code $exit_code"
    exit $exit_code
fi

log "Facility sync finished"
